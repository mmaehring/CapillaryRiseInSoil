using Plots
using Statistics
using Unitful
using UnitfulRecipes
using LsqFit
using Measurements

## Confirming the fit

#2(!)

height2 = [1.79206098, 1.76544621, 1.75657462, 1.74770303, 1.73883145,
       1.72995986, 1.72108827, 1.71221668, 1.70334509, 1.6944735 ,
       1.68560191, 1.67673032, 1.66785873, 1.65898714, 1.65011556,
       1.64124397, 1.63237238, 1.63237238, 1.62350079, 1.6146292 ,
       1.60575761, 1.59688602, 1.58801443, 1.57914284, 1.57027125,
       1.56139967, 1.55252808, 1.54365649, 1.5347849 , 1.52591331,
       1.51704172, 1.50817013, 1.49929854, 1.49042695, 1.48155536,
       1.47268378, 1.46381219, 1.4549406 , 1.44606901, 1.43719742,
       1.42832583, 1.41945424, 1.41058265, 1.40171106, 1.39283947,
       1.38396789, 1.3750963 , 1.36622471, 1.35735312, 1.34848153,
       1.33960994, 1.33073835, 1.32186676, 1.31299517, 1.30412358,
       1.295252  , 1.28638041, 1.27750882, 1.26863723, 1.25976564,
       1.25089405, 1.24202246, 1.23315087, 1.22427928, 1.21540769,
       1.20653611, 1.19766452, 1.18879293, 1.17992134, 1.17104975,
       1.16217816, 1.15330657, 1.14443498, 1.13556339, 1.1266918 ,
       1.11782022, 1.10894863, 1.10007704, 1.09120545, 1.08233386,
       1.07346227, 1.06459068, 1.05571909, 1.0468475 , 1.03797591,
       1.02910433, 1.02023274, 1.01136115, 1.00248956, 0.99361797,
       0.98474638, 0.97587479, 0.9670032 , 0.95813161, 0.94926002,
       0.94038843, 0.93151685, 0.92264526, 0.91377367, 0.90490208,
       0.89603049, 0.8871589 , 0.87828731, 0.86941572, 0.86054413,
       0.85167254, 0.84280096, 0.83392937, 0.82505778, 0.81618619,
       0.8073146 , 0.79844301, 0.78957142, 0.78069983, 0.77182824,
       0.76295665, 0.75408507, 0.74521348, 0.73634189, 0.7274703 ,
       0.71859871, 0.70972712, 0.70085553, 0.69198394, 0.68311235,
       0.67424076, 0.66536918, 0.65649759, 0.647626  , 0.63875441,
       0.62988282, 0.62101123, 0.61213964, 0.60326805, 0.59439646,
       0.58552487, 0.57665329, 0.5677817 , 0.55891011, 0.55003852,
       0.54116693, 0.53229534, 0.52342375, 0.51455216, 0.50568057,
       0.49680898, 0.4879374 , 0.47906581, 0.47019422, 0.46132263] * u"cm"
time2 = [73., 66., 64., 62., 59., 59., 57., 55., 52., 52., 52., 50., 50.,
       50., 50., 47., 47., 47., 45., 45., 43., 43., 43., 43., 40., 40.,
       40., 40., 40., 40., 40., 40., 40., 38., 38., 38., 38., 38., 36.,
       36., 36., 36., 36., 36., 36., 36., 36., 36., 33., 36., 36., 33.,
       33., 33., 33., 33., 33., 31., 31., 31., 29., 29., 29., 29., 26.,
       26., 26., 26., 24., 24., 24., 24., 24., 21., 21., 21., 21., 21.,
       19., 19., 19., 19., 19., 19., 17., 17., 17., 17., 17., 17., 17.,
       17., 17., 17., 17., 17., 17., 14., 14., 14., 14., 14., 14., 17.,
       17., 17., 17., 17., 17., 17., 17., 14., 17., 14., 14., 14., 14.,
       12., 12., 12., 14., 12., 10., 10., 10., 10., 10., 10., 10., 10.,
       10.,  7., 10., 38.,  7., 10.,  7.,  7.,  7.,  5.,  5.,  0.,  5.,
        3.,  3.,  3.,  0.,  0.,  0.,  3.] *u"s"


# 3(!)

height3 = [3.47766289, 3.4687913 , 3.45991971, 3.45104812, 3.44217654,
       3.43330495, 3.42443336, 3.41556177, 3.40669018, 3.39781859,
       3.388947  , 3.38007541, 3.37120382, 3.36233223, 3.35346065,
       3.34458906, 3.33571747, 3.32684588, 3.31797429, 3.3091027 ,
       3.30023111, 3.29135952, 3.28248793, 3.27361634, 3.26474476,
       3.25587317, 3.24700158, 3.23812999, 3.2292584 , 3.22038681,
       3.21151522, 3.20264363, 3.19377204, 3.18490045, 3.17602887,
       3.16715728, 3.15828569, 3.1494141 , 3.14054251, 3.13167092,
       3.12279933, 3.11392774, 3.10505615, 3.09618456, 3.08731298,
       3.07844139, 3.0695698 , 3.06069821, 3.05182662, 3.04295503,
       3.03408344, 3.02521185, 3.01634026, 3.00746867, 2.99859708,
       2.9897255 , 2.98085391, 2.97198232, 2.96311073, 2.95423914,
       2.94536755, 2.93649596, 2.92762437, 2.91875278, 2.90988119,
       2.90100961, 2.89213802, 2.88326643, 2.87439484, 2.86552325,
       2.85665166, 2.84778007, 2.83890848, 2.83003689, 2.8211653 ,
       2.81229372, 2.80342213, 2.79455054, 2.78567895, 2.77680736,
       2.76793577, 2.75906418, 2.75019259, 2.741321  , 2.73244941,
       2.72357783, 2.71470624, 2.70583465, 2.69696306, 2.68809147,
       2.67921988, 2.67034829, 2.6614767 , 2.65260511, 2.64373352,
       2.63486194, 2.62599035, 2.61711876, 2.60824717, 2.59937558,
       2.59050399, 2.5816324 , 2.57276081, 2.56388922, 2.55501763,
       2.54614605, 2.53727446, 2.52840287, 2.51953128, 2.51065969,
       2.5017881 , 2.49291651, 2.48404492, 2.47517333, 2.46630174,
       2.45743016, 2.44855857, 2.43968698, 2.43081539, 2.4219438 ,
       2.41307221, 2.40420062, 2.39532903, 2.38645744, 2.37758585,
       2.36871427, 2.35984268, 2.35097109, 2.3420995 , 2.33322791,
       2.32435632, 2.31548473, 2.30661314, 2.29774155, 2.28886996,
       2.27999838, 2.27112679, 2.2622552 , 2.25338361, 2.24451202,
       2.23564043, 2.22676884, 2.21789725, 2.20902566, 2.20015407,
       2.19128249, 2.1824109 , 2.17353931, 2.16466772, 2.15579613,
       2.14692454, 2.13805295, 2.12918136, 2.12030977, 2.11143818,
       2.1025666 , 2.09369501, 2.08482342, 2.07595183, 2.06708024,
       2.05820865, 2.04933706, 2.04046547, 2.03159388, 2.02272229,
       2.0138507 , 2.00497912, 1.99610753, 1.98723594, 1.97836435,
       1.96949276, 1.96062117, 1.95174958, 1.94287799, 1.9340064 ,
       1.92513481, 1.91626323, 1.90739164, 1.89852005, 1.88964846,
       1.88077687, 1.87190528, 1.86303369, 1.8541621 , 1.84529051,
       1.83641892, 1.82754734, 1.81867575, 1.80980416, 1.80093257,
       1.79206098, 1.78318939, 1.7743178 , 1.76544621, 1.75657462,
       1.74770303, 1.73883145, 1.72995986, 1.72108827, 1.71221668,
       1.70334509, 1.6944735 , 1.68560191, 1.67673032, 1.66785873,
       1.65898714, 1.65011556, 1.64124397, 1.63237238, 1.62350079,
       1.6146292 , 1.60575761, 1.59688602, 1.58801443, 1.57914284,
       1.57027125, 1.56139967, 1.55252808, 1.54365649, 1.5347849 ,
       1.52591331, 1.51704172, 1.50817013, 1.49929854, 1.49042695,
       1.48155536, 1.47268378, 1.46381219, 1.4549406 , 1.44606901,
       1.43719742, 1.42832583, 1.41945424, 1.41058265, 1.40171106,
       1.39283947, 1.38396789, 1.3750963 , 1.36622471, 1.35735312,
       1.34848153, 1.33960994, 1.33073835, 1.32186676, 1.31299517,
       1.30412358, 1.295252  , 1.28638041, 1.27750882, 1.26863723,
       1.25976564, 1.25089405, 1.24202246, 1.23315087, 1.22427928,
       1.21540769, 1.20653611, 1.19766452, 1.18879293, 1.17992134,
       1.17104975, 1.16217816, 1.15330657, 1.14443498, 1.13556339,
       1.1266918 , 1.11782022, 1.10894863, 1.10007704, 1.09120545,
       1.08233386, 1.07346227, 1.06459068, 1.05571909, 1.0468475 ,
       1.03797591, 1.02910433, 1.02023274, 1.01136115, 1.00248956,
       0.99361797, 0.98474638, 0.97587479, 0.9670032 , 0.95813161,
       0.94926002, 0.94038843, 0.93151685, 0.92264526, 0.91377367,
       0.90490208, 0.89603049, 0.8871589 , 0.87828731, 0.86941572,
       0.86054413, 0.85167254, 0.84280096, 0.83392937, 0.82505778,
       0.81618619, 0.8073146 , 0.79844301, 0.78957142, 0.78069983,
       0.77182824, 0.76295665, 0.75408507, 0.74521348, 0.73634189,
       0.7274703 , 0.71859871, 0.70972712, 0.70085553, 0.69198394,
       0.68311235, 0.67424076, 0.66536918, 0.65649759, 0.647626  ,
       0.63875441, 0.62988282, 0.62101123, 0.61213964, 0.60326805,
       0.59439646, 0.58552487, 0.57665329, 0.5677817 , 0.55891011,
       0.55003852, 0.54116693, 0.53229534, 0.52342375, 0.51455216,
       0.50568057]*u"cm";
time3 = [33., 28., 26., 26., 26., 24., 24., 21., 21., 21., 21., 19., 19.,
       19., 19., 19., 19., 17., 17., 17., 17., 17., 17., 17., 17., 17.,
       17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17.,
       17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17.,
       17., 17., 17., 17., 17., 14., 14., 14., 14., 14., 14., 14., 14.,
       14., 14., 14., 12., 12., 12., 12., 12., 12., 12., 12., 12., 12.,
       12., 12., 12., 12., 12., 12., 12., 12., 12., 12., 12., 12., 12.,
       12., 12., 12., 12., 10., 10., 10., 10., 10., 10., 10., 10., 10.,
       10., 10., 10., 10., 10., 10., 10., 10., 10., 10., 10., 10., 10.,
       10., 10., 10., 10.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,
        7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,
        7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,
        7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,
        7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  5.,
        5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,
        5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,
        5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,
        5.,  5.,  5.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.] * u"s";
# =#

height4 = [3.26474476, 3.25587317, 3.24700158, 3.23812999, 3.2292584 ,
       3.22038681, 3.21151522, 3.20264363, 3.19377204, 3.18490045,
       3.17602887, 3.16715728, 3.15828569, 3.1494141 , 3.14054251,
       3.13167092, 3.12279933, 3.11392774, 3.10505615, 3.09618456,
       3.08731298, 3.07844139, 3.0695698 , 3.06069821, 3.05182662,
       3.04295503, 3.03408344, 3.02521185, 3.01634026, 3.00746867,
       2.99859708, 2.9897255 , 2.98085391, 2.97198232, 2.96311073,
       2.95423914, 2.94536755, 2.93649596, 2.92762437, 2.91875278,
       2.90988119, 2.90100961, 2.89213802, 2.88326643, 2.87439484,
       2.86552325, 2.85665166, 2.84778007, 2.83890848, 2.83003689,
       2.8211653 , 2.81229372, 2.80342213, 2.79455054, 2.78567895,
       2.77680736, 2.76793577, 2.75906418, 2.75019259, 2.741321  ,
       2.73244941, 2.72357783, 2.71470624, 2.70583465, 2.69696306,
       2.68809147, 2.67921988, 2.67034829, 2.6614767 , 2.65260511,
       2.64373352, 2.63486194, 2.62599035, 2.61711876, 2.60824717,
       2.59937558, 2.59050399, 2.5816324 , 2.57276081, 2.56388922,
       2.55501763, 2.54614605, 2.53727446, 2.52840287, 2.51953128,
       2.51065969, 2.5017881 , 2.49291651, 2.48404492, 2.47517333,
       2.46630174, 2.45743016, 2.44855857, 2.43968698, 2.43081539,
       2.4219438 , 2.41307221, 2.40420062, 2.39532903, 2.38645744,
       2.37758585, 2.36871427, 2.35984268, 2.35097109, 2.3420995 ,
       2.33322791, 2.32435632, 2.31548473, 2.30661314, 2.29774155,
       2.28886996, 2.27999838, 2.27112679, 2.2622552 , 2.25338361,
       2.24451202, 2.23564043, 2.22676884, 2.21789725, 2.20902566,
       2.20015407, 2.19128249, 2.1824109 , 2.17353931, 2.16466772,
       2.15579613, 2.14692454, 2.13805295, 2.12918136, 2.12030977,
       2.11143818, 2.1025666 , 2.09369501, 2.08482342, 2.07595183,
       2.06708024, 2.05820865, 2.04933706, 2.04046547, 2.03159388,
       2.02272229, 2.0138507 , 2.00497912, 1.99610753, 1.98723594,
       1.97836435, 1.96949276, 1.96062117, 1.95174958, 1.94287799,
       1.9340064 , 1.92513481, 1.91626323, 1.90739164, 1.89852005,
       1.88964846, 1.88077687, 1.87190528, 1.86303369, 1.8541621 ,
       1.84529051, 1.83641892, 1.82754734, 1.81867575, 1.80980416,
       1.80093257, 1.79206098, 1.78318939, 1.7743178 , 1.76544621,
       1.75657462, 1.74770303, 1.73883145, 1.72995986, 1.72108827,
       1.71221668, 1.70334509, 1.6944735 , 1.68560191, 1.67673032,
       1.66785873, 1.65898714, 1.65011556, 1.64124397, 1.63237238,
       1.62350079, 1.6146292 , 1.60575761, 1.59688602, 1.58801443,
       1.57914284, 1.57027125, 1.56139967, 1.55252808, 1.54365649,
       1.5347849 , 1.52591331, 1.51704172, 1.50817013, 1.49929854,
       1.49042695, 1.48155536, 1.47268378, 1.46381219, 1.4549406 ,
       1.44606901, 1.43719742, 1.42832583, 1.41945424, 1.41058265,
       1.40171106, 1.39283947, 1.38396789, 1.3750963 , 1.36622471,
       1.35735312, 1.34848153, 1.33960994, 1.33073835, 1.32186676,
       1.31299517, 1.30412358, 1.295252  , 1.28638041, 1.27750882,
       1.26863723, 1.25976564, 1.25089405, 1.24202246, 1.23315087,
       1.22427928, 1.21540769, 1.20653611, 1.19766452, 1.18879293,
       1.17992134, 1.17104975, 1.16217816, 1.15330657, 1.14443498,
       1.13556339, 1.1266918 , 1.11782022, 1.10894863, 1.10007704,
       1.09120545, 1.08233386, 1.07346227, 1.06459068, 1.05571909,
       1.0468475 , 1.03797591, 1.02910433, 1.02023274, 1.01136115,
       1.00248956, 0.99361797, 0.98474638, 0.97587479, 0.9670032 ,
       0.95813161, 0.94926002, 0.94038843, 0.93151685, 0.92264526,
       0.91377367, 0.90490208, 0.89603049, 0.8871589 , 0.87828731,
       0.86941572, 0.86054413, 0.85167254, 0.84280096, 0.83392937,
       0.82505778, 0.81618619, 0.8073146 , 0.79844301, 0.78957142,
       0.78069983, 0.77182824, 0.76295665, 0.75408507, 0.74521348,
       0.73634189, 0.7274703 , 0.71859871, 0.70972712, 0.70085553,
       0.69198394, 0.68311235, 0.67424076, 0.66536918, 0.65649759,
       0.647626  , 0.63875441, 0.62988282, 0.62101123, 0.61213964,
       0.60326805, 0.59439646, 0.58552487, 0.57665329, 0.5677817 ,
       0.55891011, 0.55003852, 0.54116693, 0.53229534, 0.52342375] * u"cm"
time4 = [19., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17., 17.,
       17., 17., 17., 15., 15., 15., 15., 15., 15., 15., 15., 15., 15.,
       15., 15., 15., 15., 15., 15., 15., 15., 15., 15., 15., 15., 15.,
       15., 15., 15., 15., 15., 15., 15., 15., 12., 12., 12., 12., 12.,
       12., 12., 12., 12., 12., 12., 12., 12., 12., 12., 12., 12., 12.,
       12., 12., 12., 12., 12., 10., 10., 10., 10., 10., 10., 10., 10.,
       10., 10., 10., 10., 10., 10., 10., 10., 10., 10., 10., 10., 10.,
       10., 10., 10., 10., 10., 10.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,
        7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,
        7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,  7.,
        7.,  7.,  7.,  7.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,
        5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,
        5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,
        5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,  5.,
        5.,  5.,  5.,  5.,  5.,  5.,  5.,  3.,  3.,  3.,  3.,  3.,  3.,
        3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,
        3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,
        3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,
        3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,
        3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  3.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.] * u"s"

@. model(x, p) = p[1]*sqrt(x) + p[2];

p0=[2.5u"cm/√s", 0.1u"cm"];
fit = curve_fit(model, ustrip.(time3), ustrip.(height3), ustrip.(p0));
sigma = stderror(fit)
confidence_interval(fit)

coeffs, disp = fit.param
coeffs = coeffs*u"cm/√s";
disp = disp*u"cm";

new_model(t) =  coeffs * sqrt(t*u"s") + disp

plot(time3, new_model.(ustrip.(time3)),
        legend=:topleft, label="Fitted model", xlabel="Time", ylabel="Penetrated depth")
scatter!(time3, height3, label=:none, color = :orange)
# plot!(time, height, label="Recorded data", color=:orange)

## Calculating the
γ = 72e-3u"N/m" # newtons per meter
η = 8.9e-4u"Pa*s" # Pa * s
ϕ = 50u"°" # degree
ϕ_rad = ϕ|>u"rad"

r = 2 * coeffs^2 * η / (γ * cos(ϕ_rad))
r1 = r |>u"cm^2/m"
r15 = r1 |> u"cm^2/cm"
r_μm = r |> u"μm"

# using Distributions
# function validity_of_fit(new_model, height, time, cutoff = 1)
#         if cutoff > 1
#                 height = height[cutoff:end]
#                 time = time[cutoff:end]
#         end
#
#         height = ustrip.(height)
#         height = [(i ± (i * 0.071)) for i in height]
#         calc_height = ustrip(new_model.(ustrip.(time)))
#
#
#         flot = scatter(time3, calc_height, legend=:topleft, label="Fitted model", xlabel="Time", ylabel="Penetrated depth")
#         scatter!(time3, height3, label=:none, color = :orange)
#
#         χ² = sum( (calc_height .- Measurements.value.(height)).^2 ./ Measurements.uncertainty.(height).^2 )
# end
#
# χ²3 = validity_of_fit(new_model, height3, time3, 10)
# χ²ndof3 = χ²3 / (length(height3) - 2)
#
# evaluate_chisq(chisq, dof) =  1 - cdf(Distributions.Chisq(dof), chisq)
#
# p3 = evaluate_chisq(χ²ndof3, length(height3) - 2)
